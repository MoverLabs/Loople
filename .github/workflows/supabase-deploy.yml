name: Supabase Deploy

on:
  push:
    branches:
      - staging
    paths:
      - 'supabase/**'
  workflow_dispatch:  # Allow manual triggers

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}
  PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID_STAGING }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff comparison

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: |
          echo "Logging in to Supabase..."
          supabase login "$SUPABASE_ACCESS_TOKEN"
          if [ $? -ne 0 ]; then
            echo "::error::Failed to login to Supabase"
            exit 1
          fi
        
      - name: Setup Supabase project
        run: |
          echo "Linking Supabase project..."
          supabase link --project-ref "$PROJECT_ID"
          if [ $? -ne 0 ]; then
            echo "::error::Failed to link Supabase project"
            exit 1
          fi
        
      - name: Get changed files
        id: changed-files
        run: |
          echo "Checking for changes in supabase directory..."
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^supabase/' || true)
          echo "Changed files in supabase directory:"
          echo "$CHANGED_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy database changes
        if: contains(steps.changed-files.outputs.changed_files, 'migrations') || contains(steps.changed-files.outputs.changed_files, 'seed.sql')
        run: |
          echo "Deploying database changes..."
          
          # Initialize Supabase config if needed
          if [ ! -f "supabase/config.toml" ]; then
            echo "Initializing Supabase configuration..."
            supabase init
          fi
          
          echo "Running db push..."
          supabase db push 2>&1 | tee db_push.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Database migration failed. Check logs for details."
            cat db_push.log
            exit 1
          fi
          
          if [[ -f "supabase/seed.sql" ]]; then
            echo "Running seed file..."
            supabase db reset 2>&1 | tee seed.log
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "::error::Database seeding failed. Check logs for details."
              cat seed.log
              exit 1
            fi
          fi

      - name: Deploy Edge Functions
        if: contains(steps.changed-files.outputs.changed_files, 'functions')
        run: |
          echo "Deploying Edge Functions..."
          # List all function directories
          for func_dir in supabase/functions/*/; do
            if [ -d "$func_dir" ]; then
              func_name=$(basename "$func_dir")
              echo "Deploying function: $func_name"
              supabase functions deploy "$func_name" 2>&1 | tee "function_${func_name}.log"
              if [ ${PIPESTATUS[0]} -ne 0 ]; then
                echo "::error::Function deployment failed for $func_name. Check logs for details."
                cat "function_${func_name}.log"
                exit 1
              fi
            fi
          done

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: |
            *.log
          retention-days: 7

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Deployment failed. Please check the logs for details."
            exit 1
          fi 