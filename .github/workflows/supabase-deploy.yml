name: Supabase Deploy

on:
  push:
    branches:
      - staging
    paths:
      - 'supabase/**'
  workflow_dispatch:  # Allow manual triggers

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}
  PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID_STAGING }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase CLI
        run: |
          npm install -g supabase
          echo "Supabase CLI version:"
          supabase --version
        
      - name: Setup Supabase project
        run: |
          echo "Linking Supabase project..."
          supabase link --project-ref $PROJECT_ID --password $SUPABASE_DB_PASSWORD
          if [ $? -ne 0 ]; then
            echo "::error::Failed to link Supabase project"
            exit 1
          fi
        
      - name: Get changed files
        id: changed-files
        run: |
          echo "Checking for changes in supabase directory..."
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^supabase/' || true)
          echo "Changed files in supabase directory:"
          echo "$CHANGED_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy database changes
        if: contains(steps.changed-files.outputs.changed_files, 'migrations') || contains(steps.changed-files.outputs.changed_files, 'seed.sql')
        run: |
          echo "Deploying database changes..."
          echo "Running db push..."
          supabase db push --password $SUPABASE_DB_PASSWORD 2>&1 | tee db_push.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Database migration failed. Check logs for details."
            cat db_push.log
            exit 1
          fi
          
          if [[ -f "supabase/seed.sql" ]]; then
            echo "Running seed file..."
            supabase db reset --password $SUPABASE_DB_PASSWORD 2>&1 | tee seed.log
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "::error::Database seeding failed. Check logs for details."
              cat seed.log
              exit 1
            fi
          fi

      - name: Deploy Edge Functions
        if: contains(steps.changed-files.outputs.changed_files, 'functions')
        run: |
          echo "Deploying Edge Functions..."
          supabase functions deploy --project-ref $PROJECT_ID 2>&1 | tee functions.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Edge Functions deployment failed. Check logs for details."
            cat functions.log
            exit 1
          fi

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: |
            *.log
          retention-days: 7

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Deployment failed. Please check the logs for details."
            exit 1
          fi 