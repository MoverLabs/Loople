name: Deploy Supabase Migrations

on:
  push:
    branches: [main, staging]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'supabase/config.toml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Debug directory structure
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "Git status:"
          git status
          echo "Git log:"
          git log -n 1
          echo "Checking supabase directory:"
          ls -la supabase || echo "supabase directory not found"
          if [ -d "supabase" ]; then
            echo "Contents of supabase directory:"
            ls -la supabase/
            echo "Contents of supabase/migrations directory:"
            ls -la supabase/migrations/
          fi

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set environment variables
        id: set-env
        run: |
          if [[ $GITHUB_REF == "refs/heads/main" ]]; then
            echo "SUPABASE_PROJECT_ID=${{ secrets.SUPABASE_PROJECT_ID_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_DB_PASSWORD=${{ secrets.SUPABASE_DB_PASSWORD_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_BRANCH=main" >> $GITHUB_ENV
          elif [[ $GITHUB_REF == "refs/heads/staging" ]]; then
            echo "SUPABASE_PROJECT_ID=${{ secrets.SUPABASE_PROJECT_ID_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_DB_PASSWORD=${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_BRANCH=staging" >> $GITHUB_ENV
          fi

      - name: Deploy Database Changes
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ env.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ env.SUPABASE_DB_PASSWORD }}
        run: |
          if [ ! -d "supabase" ]; then
            echo "Error: supabase directory not found"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          cd supabase
          echo "Deploying to ${{ env.SUPABASE_BRANCH }} branch..."
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          
          echo "Linking to Supabase project..."
          supabase link --project-ref $SUPABASE_PROJECT_ID --password $SUPABASE_DB_PASSWORD
          
          echo "Pushing database changes..."
          supabase db push
          
          # Deploy functions if they exist
          if [ -d "functions" ]; then
            echo "Deploying edge functions..."
            for dir in functions/*/; do
              if [ -f "$dir/index.ts" ]; then
                func_name=$(basename "$dir")
                echo "Deploying $func_name to ${{ env.SUPABASE_BRANCH }}..."
                supabase functions deploy $func_name --project-ref $SUPABASE_PROJECT_ID --branch ${{ env.SUPABASE_BRANCH }}
              fi
            done
          fi 