name: Deploy to Supabase

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_ACCESS_TOKEN_MAIN || secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
      SUPABASE_DB_PASSWORD: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_DB_PASSWORD_MAIN || secrets.SUPABASE_DB_PASSWORD_STAGING }}
      SUPABASE_PROJECT_ID: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_PROJECT_ID_MAIN || secrets.SUPABASE_PROJECT_ID_STAGING }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for migrations

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: |
          echo "Logging in to Supabase..."
          supabase login ${{ env.SUPABASE_ACCESS_TOKEN }}
          if [ $? -ne 0 ]; then
            echo "Failed to login to Supabase"
            exit 1
          fi

      - name: Link to Supabase project
        run: |
          echo "Linking to project: ${{ env.SUPABASE_PROJECT_ID }}"
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_ID }} --password ${{ env.SUPABASE_DB_PASSWORD }}
          if [ $? -ne 0 ]; then
            echo "Failed to link project"
            exit 1
          fi
          
          # Verify project is linked
          supabase status
          if [ $? -ne 0 ]; then
            echo "Project status check failed"
            exit 1
          fi

      - name: Update project configuration
        run: |
          echo "Updating project configuration..."
          # Show current config differences
          supabase db remote changes --linked
          
          # Pull remote configuration
          supabase db remote commit --linked
          if [ $? -ne 0 ]; then
            echo "Failed to update configuration"
            exit 1
          fi

      - name: Repair Migration History
        if: github.event_name == 'push'
        run: |
          echo "Repairing migration history..."
          # First mark problematic migrations as reverted
          supabase migration repair --status reverted 20240319000000 || true
          supabase migration repair --status reverted 20250616 || true
          supabase migration repair --status reverted 20250617 || true
          
          # Then mark them as applied in the correct order
          supabase migration repair --status applied 20250616 || true
          supabase migration repair --status applied 20250617 || true
          
          # Verify migration status
          supabase migration list
          if [ $? -ne 0 ]; then
            echo "Migration status check failed"
            exit 1
          fi

      - name: Sync and Deploy Database Changes
        if: github.event_name == 'push'
        run: |
          echo "Pulling current database state..."
          supabase db pull || true
          
          echo "Pushing new migrations..."
          supabase db push --debug
          if [ $? -ne 0 ]; then
            echo "Failed to push database changes"
            exit 1
          fi

      - name: Deploy Supabase Edge Functions
        if: github.event_name == 'push'
        run: |
          # Get absolute path to functions directory
          FUNCTIONS_DIR="$GITHUB_WORKSPACE/supabase/functions"
          cd "$FUNCTIONS_DIR"
          
          echo "Functions directory: $FUNCTIONS_DIR"
          
          # List all functions before deployment
          echo "Available functions:"
          ls -la "$FUNCTIONS_DIR"
          
          DEPLOY_SUCCESS=true
          
          for d in */ ; do
            if [ -d "$d" ] && [[ ! "$d" =~ ^_.*/ ]]; then
              func_name=${d%/}
              echo "Checking function: $func_name"
              
              if [ -f "$func_name/index.ts" ]; then
                echo "Found index.ts in $func_name"
                echo "Full path: $FUNCTIONS_DIR/$func_name/index.ts"
                
                # Deploy from the root directory
                cd "$GITHUB_WORKSPACE"
                echo "Deploying function: $func_name"
                if ! supabase functions deploy "$func_name" --project-ref ${{ env.SUPABASE_PROJECT_ID }} --debug; then
                  echo "Failed to deploy function: $func_name"
                  DEPLOY_SUCCESS=false
                fi
                cd "$FUNCTIONS_DIR"
              else
                echo "Warning: index.ts not found in $func_name"
                ls -la "$FUNCTIONS_DIR/$func_name"
              fi
            else
              echo "Skipping directory: $d (starts with underscore or not a directory)"
            fi
          done
          
          if [ "$DEPLOY_SUCCESS" = false ]; then
            echo "One or more functions failed to deploy"
            exit 1
          fi

      - name: Run seed script (only on staging)
        if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
        run: |
          echo "Running seed script on staging..."
          # Use --yes flag to skip confirmation prompt
          supabase db reset --linked --yes
          if [ $? -ne 0 ]; then
            echo "Failed to run seed script"
            exit 1
          fi
          
          # Verify seed data
          echo "Verifying seed data..."
          supabase db dump --linked

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          supabase status
          if [ $? -ne 0 ]; then
            echo "Final status check failed"
            exit 1
          fi 