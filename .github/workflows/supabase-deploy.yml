name: Supabase Deploy

on:
  push:
    branches:
      - staging
    paths:
      - 'supabase/**'
  workflow_dispatch:  # Allow manual triggers

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
  PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID_STAGING }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff comparison

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Setup Supabase credentials
        run: |
          # Create config directory
          mkdir -p ~/.config/supabase
          
          # Store access token
          echo "{\"access_token\":\"$SUPABASE_ACCESS_TOKEN\"}" > ~/.config/supabase/access-token

      - name: Get Database Connection Info
        id: db-info
        run: |
          echo "Fetching database configuration..."
          
          # Get database configuration
          DB_CONFIG=$(curl -s -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
            https://api.supabase.com/v1/projects/$PROJECT_ID/config/database/postgres)
          
          # Extract connection info
          DB_HOST=$(echo $DB_CONFIG | jq -r '.db_host')
          DB_PORT=$(echo $DB_CONFIG | jq -r '.db_port')
          DB_USER=$(echo $DB_CONFIG | jq -r '.db_user')
          DB_PASS=$(echo $DB_CONFIG | jq -r '.db_pass')
          
          if [ -z "$DB_HOST" ] || [ -z "$DB_PORT" ] || [ -z "$DB_USER" ] || [ -z "$DB_PASS" ]; then
            echo "::error::Failed to get complete database configuration"
            exit 1
          fi
          
          # Save to outputs
          {
            echo "db_host=$DB_HOST"
            echo "db_port=$DB_PORT"
            echo "db_user=$DB_USER"
            echo "db_pass=$DB_PASS"
          } >> $GITHUB_OUTPUT
          
          # Create connection config
          cat > ~/.config/supabase/connection.env << EOF
          DB_HOST=$DB_HOST
          DB_PORT=$DB_PORT
          DB_USER=$DB_USER
          DB_PASS=$DB_PASS
          EOF

      - name: Link Supabase Project
        run: |
          echo "Linking Supabase project..."
          echo "Project ID: $PROJECT_ID"
          echo "Host: ${{ steps.db-info.outputs.db_host }}"
          echo "Port: ${{ steps.db-info.outputs.db_port }}"
          echo "User: ${{ steps.db-info.outputs.db_user }}"
          
          # Try linking with connection info
          supabase link \
            --project-ref "$PROJECT_ID" \
            --db-url "postgresql://${{ steps.db-info.outputs.db_user }}:${{ steps.db-info.outputs.db_pass }}@${{ steps.db-info.outputs.db_host }}:${{ steps.db-info.outputs.db_port }}/postgres" \
            --debug
          
          if [ $? -ne 0 ]; then
            echo "::error::Failed to link Supabase project. Check the debug output above."
            exit 1
          fi
        
      - name: Get changed files
        id: changed-files
        run: |
          echo "Checking for changes in supabase directory..."
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^supabase/' || true)
          echo "Changed files in supabase directory:"
          echo "$CHANGED_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy database changes
        if: contains(steps.changed-files.outputs.changed_files, 'migrations') || contains(steps.changed-files.outputs.changed_files, 'seed.sql')
        env:
          DB_CONNECTION: postgresql://${{ steps.db-info.outputs.db_user }}:${{ steps.db-info.outputs.db_pass }}@${{ steps.db-info.outputs.db_host }}:${{ steps.db-info.outputs.db_port }}/postgres
        run: |
          echo "Deploying database changes..."
          
          echo "Running db push..."
          supabase db push --db-url "$DB_CONNECTION" --debug 2>&1 | tee db_push.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Database migration failed. Check logs for details."
            cat db_push.log
            exit 1
          fi
          
          if [[ -f "supabase/seed.sql" ]]; then
            echo "Running seed file..."
            supabase db reset --db-url "$DB_CONNECTION" --debug 2>&1 | tee seed.log
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "::error::Database seeding failed. Check logs for details."
              cat seed.log
              exit 1
            fi
          fi

      - name: Deploy Edge Functions
        if: contains(steps.changed-files.outputs.changed_files, 'functions')
        run: |
          echo "Deploying Edge Functions..."
          # List all function directories
          for func_dir in supabase/functions/*/; do
            if [ -d "$func_dir" ]; then
              func_name=$(basename "$func_dir")
              echo "Deploying function: $func_name"
              supabase functions deploy "$func_name" --debug 2>&1 | tee "function_${func_name}.log"
              if [ ${PIPESTATUS[0]} -ne 0 ]; then
                echo "::error::Function deployment failed for $func_name. Check logs for details."
                cat "function_${func_name}.log"
                exit 1
              fi
            fi
          done

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs
          path: |
            *.log
          retention-days: 7

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Deployment failed. Please check the logs for details."
            exit 1
          fi 