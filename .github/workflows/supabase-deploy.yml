name: Deploy to Supabase

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_ACCESS_TOKEN_MAIN || secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
      SUPABASE_DB_PASSWORD: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_DB_PASSWORD_MAIN || secrets.SUPABASE_DB_PASSWORD_STAGING }}
      SUPABASE_PROJECT_ID: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_PROJECT_ID_MAIN || secrets.SUPABASE_PROJECT_ID_STAGING }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for migrations

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: |
          echo "Logging in to Supabase..."
          supabase login ${{ env.SUPABASE_ACCESS_TOKEN }}

      - name: Link to Supabase project
        run: |
          echo "Linking to project: ${{ env.SUPABASE_PROJECT_ID }}"
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_ID }} --password ${{ env.SUPABASE_DB_PASSWORD }}

      # - name: Reset Database (only on staging)
      #   if: github.ref == 'refs/heads/staging'
      #   run: |
      #     echo "Resetting staging database..."
      #     echo "y" | supabase db reset --linked

      - name: Apply Schema Migrations
        if: github.event_name == 'push'
        run: |
          echo "Applying schema migrations..."
          supabase db push

      # - name: Run Seed Script (only on staging)
      #   if: github.ref == 'refs/heads/staging'
      #   run: |
      #     echo "Running seed script..."
      #     # Get the database hostname
      #     DB_HOST="db.${{ env.SUPABASE_PROJECT_ID }}.supabase.co"
      #     echo "Database host: $DB_HOST"
          
      #     # Resolve the IP address
      #     DB_IP=$(dig +short $DB_HOST | grep -v ':' | head -n 1)
      #     echo "Database IP: $DB_IP"
          
      #     if [ -z "$DB_IP" ]; then
      #       echo "Failed to resolve database IP address"
      #       exit 1
      #     fi
          
      #     # Run the seed script using the IP address
      #     PGPASSWORD="${{ env.SUPABASE_DB_PASSWORD }}" psql "host=$DB_IP port=5432 dbname=postgres user=postgres" -f supabase/seed.sql

      - name: Deploy and Verify Supabase Edge Functions
        if: github.event_name == 'push'
        run: |
          echo "Starting Edge Functions deployment..."
          
          # List all functions before deployment
          echo "Current functions:"
          supabase functions list --project-ref ${{ env.SUPABASE_PROJECT_ID }}
          
          # Deploy each function
          cd supabase/functions
          for d in */ ; do
            if [ -d "$d" ] && [[ ! "$d" =~ ^_.*/ ]]; then
              func_name=${d%/}
              if [ -f "$d/index.ts" ]; then
                echo "Deploying function: $func_name"
                supabase functions deploy "$func_name" --project-ref ${{ env.SUPABASE_PROJECT_ID }} --no-verify-jwt || {
                  echo "Failed to deploy function: $func_name"
                  exit 1
                }
                
                # Verify deployment
                echo "Verifying deployment of $func_name..."
                supabase functions list --project-ref ${{ env.SUPABASE_PROJECT_ID }} | grep -q "$func_name" || {
                  echo "Function $func_name not found after deployment!"
                  exit 1
                }
                echo "âœ“ Function $func_name deployed and verified"
              else
                echo "Warning: index.ts not found in $func_name"
                ls -la "$d"
              fi
            fi
          done
          
          # List all functions after deployment
          echo "Updated functions list:"
          supabase functions list --project-ref ${{ env.SUPABASE_PROJECT_ID }} 