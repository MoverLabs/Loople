name: Deploy to Supabase

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_ACCESS_TOKEN_MAIN || secrets.SUPABASE_ACCESS_TOKEN_STAGING }}
      SUPABASE_DB_PASSWORD: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_DB_PASSWORD_MAIN || secrets.SUPABASE_DB_PASSWORD_STAGING }}
      SUPABASE_PROJECT_ID: ${{ github.ref == 'refs/heads/main' && secrets.SUPABASE_PROJECT_ID_MAIN || secrets.SUPABASE_PROJECT_ID_STAGING }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for migrations

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: |
          echo "Logging in to Supabase..."
          supabase login ${{ env.SUPABASE_ACCESS_TOKEN }}

      - name: Link to Supabase project
        run: |
          echo "Linking to project: ${{ env.SUPABASE_PROJECT_ID }}"
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_ID }} --password ${{ env.SUPABASE_DB_PASSWORD }}

      - name: Apply Schema Migrations
        if: github.event_name == 'push'
        run: |
          echo "Applying schema migrations..."
          supabase db push

      # - name: Update Email Templates
      #   if: github.event_name == 'push'
      #   working-directory: scripts
      #   env:
      #     SUPABASE_PROJECT_ID: ${{ env.SUPABASE_PROJECT_ID }}
      #     SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}
      #   run: |
      #     echo "Installing dependencies..."
      #     npm install
      #     echo "Updating email templates..."
      #     npx tsx update-email-templates.ts

      - name: Deploy Supabase Edge Functions
        if: github.event_name == 'push'
        run: |
          # Get absolute path to functions directory
          FUNCTIONS_DIR="$GITHUB_WORKSPACE/supabase/functions"
          cd "$FUNCTIONS_DIR"
          
          echo "Functions directory: $FUNCTIONS_DIR"
          
          # Deploy functions
          for d in */ ; do
            if [[ ! "$d" =~ ^_.*/ ]]; then  # Skip _shared and other utility folders
              func_dir=${d%/}  # Remove trailing slash
              
              # First check for index.ts in the directory (main endpoint)
              if [ -f "$func_dir/index.ts" ]; then
                echo "Deploying main endpoint: $func_dir"
                cd "$GITHUB_WORKSPACE"
                supabase functions deploy "$func_dir" --project-ref ${{ env.SUPABASE_PROJECT_ID }}
                cd "$FUNCTIONS_DIR"
              fi
              
              # Then check for other .ts files (sub-endpoints)
              for ts_file in "$func_dir"/*.ts; do
                if [ -f "$ts_file" ] && [ "$(basename "$ts_file")" != "index.ts" ]; then
                  # Get the filename without .ts
                  func_name=$(basename "$ts_file" .ts)
                  # Create the endpoint name (e.g., clubs/join.ts -> clubs-join)
                  endpoint_name="$func_dir-$func_name"
                  
                  echo "Found sub-endpoint: $ts_file"
                  echo "Deploying as: $endpoint_name"
                  
                  # Create a temporary directory for this endpoint
                  temp_dir="$FUNCTIONS_DIR/$endpoint_name"
                  mkdir -p "$temp_dir"
                  cp "$ts_file" "$temp_dir/index.ts"
                  
                  # Deploy from the temporary directory
                  cd "$GITHUB_WORKSPACE"
                  supabase functions deploy "$endpoint_name" --project-ref ${{ env.SUPABASE_PROJECT_ID }}
                  cd "$FUNCTIONS_DIR"
                  
                  # Clean up
                  rm -rf "$temp_dir"
                fi
              done
            fi
          done 