name: Deploy Supabase Migrations

on:
  push:
    branches: [main, staging]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'supabase/config.toml'
      - 'supabase/seed.sql'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Debug directory structure
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "Git status:"
          git status
          echo "Git log:"
          git log -n 1
          echo "Checking supabase directory:"
          ls -la supabase || echo "supabase directory not found"
          if [ -d "supabase" ]; then
            echo "Contents of supabase directory:"
            ls -la supabase/
            echo "Contents of supabase/migrations directory:"
            ls -la supabase/migrations/
          fi

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set environment variables
        id: set-env
        run: |
          if [[ $GITHUB_REF == "refs/heads/main" ]]; then
            echo "Using main environment"
            echo "SUPABASE_URL=${{ secrets.SUPABASE_URL_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_PROJECT_ID=${{ secrets.SUPABASE_PROJECT_ID_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_DB_PASSWORD=${{ secrets.SUPABASE_DB_PASSWORD_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_ACCESS_TOKEN=${{ secrets.SUPABASE_ACCESS_TOKEN_MAIN }}" >> $GITHUB_ENV
            echo "SUPABASE_BRANCH=main" >> $GITHUB_ENV
          elif [[ $GITHUB_REF == "refs/heads/staging" ]]; then
            echo "Using staging environment"
            echo "SUPABASE_URL=${{ secrets.SUPABASE_URL_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_PROJECT_ID=${{ secrets.SUPABASE_PROJECT_ID_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_DB_PASSWORD=${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_ACCESS_TOKEN=${{ secrets.SUPABASE_ACCESS_TOKEN_STAGING }}" >> $GITHUB_ENV
            echo "SUPABASE_BRANCH=staging" >> $GITHUB_ENV
          fi

      - name: Deploy Database Changes
        env:
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ env.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ env.SUPABASE_DB_PASSWORD }}
        run: |
          echo "Deploying to ${{ env.SUPABASE_BRANCH }} branch..."
          echo "Project ID: $SUPABASE_PROJECT_ID"
          
          if [[ "${{ env.SUPABASE_BRANCH }}" == "staging" ]]; then
            echo "Staging branch: Setting up fresh environment..."
            supabase init --force
            supabase link --project-ref "$SUPABASE_PROJECT_ID"
            supabase db reset
          else
            echo "Main branch: Syncing with existing database..."
            
            # Link to the project
            supabase link --project-ref "$SUPABASE_PROJECT_ID"
            
            # Try to repair migration history
            echo "Attempting to repair migration history..."
            supabase migration repair --status reverted 20240319000000 || true
            supabase migration repair --status reverted 20250616 || true
            supabase migration repair --status reverted 20250617 || true
            supabase migration repair --status applied 20250616 || true
            supabase migration repair --status applied 20250617 || true
            
            # Pull and push carefully
            echo "Syncing database changes..."
            supabase db pull || true
            
            if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations)" ]; then
              echo "Applying migrations..."
              supabase db push || true
            fi
          fi
          
          # Deploy functions if they exist
          if [ -d "supabase/functions" ]; then
            echo "Deploying edge functions..."
            for dir in supabase/functions/*/; do
              if [ -f "$dir/index.ts" ]; then
                func_name=$(basename "$dir")
                echo "Deploying $func_name..."
                supabase functions deploy "$func_name" --project-ref "$SUPABASE_PROJECT_ID"
              fi
            done
          fi 